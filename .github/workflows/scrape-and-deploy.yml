name: Scrape and Deploy

on:
  schedule:
    # 매일 한국시간 17:15 (UTC 08:15)
    - cron: "15 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ✅ uv 설치 (공식 액션)
      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      # ✅ uv로 의존성 설치
      - name: Install dependencies (uv)
        working-directory: daily-stockbrief   # pyproject.toml 있는 폴더
        run: |
          uv sync --frozen
          uv run playwright install --with-deps chromium

      # ✅ uv 환경에서 스크래퍼 실행
      - name: Run scraper
        working-directory: daily-stockbrief
        run: |
          uv run python main.py

      - name: Commit & Push scraped data
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git pull --rebase origin main || echo "No rebase needed"

          git add daily-stockbrief-web/public/data || echo "Nothing to add"
          git commit -m "Auto-update data $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push origin HEAD:main || echo "Nothing to push"

      - name: Trigger Vercel Deploy
        run: |
          curl -X POST "https://api.vercel.com/v1/integrations/deploy/prj_1owM8Ih4nQCzd1yAp7JTj17YzXN2" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
          || echo "Vercel redeploy skipped"
